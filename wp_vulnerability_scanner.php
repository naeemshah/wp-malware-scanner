<?php
/**
 * Plugin Name: WP Malware Scanner
 * Plugin URI: 
 * Description: Scan installed pluigns for vulnerabilities
 * Version: 1.4.0
 * Author: Naeem Shah
 * Author URI: 
 * Requires at least: 3.0
 * Tested up to: 4.9.6
 *
 * Text Domain: 
 * Domain Path: 
 *
 */



require_once 'class.scanner.php';




$wvp = new WP_Vul_Scanner();

$wvp->init();
add_action('pre_current_active_plugins','addCustomImportButton');

 function addCustomImportButton()
{

	
    global $current_screen;

   

    ?>
        <script type="text/javascript">
            jQuery(document).ready( function($)
            {
            	if(typeof wp_scanner != "undefinded"){
                wp_scanner.addHtml(".bulkactions","<a style='display:inline-block' class='button-primary wp_scanner-btn'  id='wp_scanner' href='javascript:void(0)' >Scan Pluigns for Vulnerabilities</a><i id='wp_vul_spinner' style='display:none' class='spinner is-active'></i>");
               jQuery(document).on("click","#wp_scanner",function(){
                jQuery("#wp_vul_spinner").show();
                jQuery(".wp_vul_alert").remove();
                jQuery(".wp_scanner-btn").attr("disabled",true);
                var $this = this;
                  jQuery.ajax({
                    url : "<?php echo admin_url( 'admin-ajax.php' ); ?>",
                    data : {action:"wp_vul_scan"},
                    success:function(data){
                        jQuery("#wp_vul_spinner").hide();
                        
                        jQuery(".wp_scanner-btn").attr("disabled",false);
                       if(data.status == 1){
                        jQuery.each(data.data,function(pluginName,item){
                          var tag = "<div  style='background:green;text-align:center;color:white' class='wp_vul_alert'>No vulnerability Found</div>";
                            if(item != false && item.is_vul){
                               tag = "<div style='background:red;text-align:center;color:black' class='wp_vul_alert'>"+item.is_vul+" vulnerability Found</div>";
                            }else if(item != false && !item.is_vul && item.maybe_vul){
                                    tag = "<div style='background:yellow;text-align:center;color:black' class='wp_vul_alert'>This plugin maybe  vulnerable. please update this plugin</div>";
                            }
                           jQuery("tr[data-slug='"+pluginName+"'] .plugin-title").append(tag);
                        })
                       }
                    }
                  })
               });
          
              }

            });
        </script>
    <?php
}
